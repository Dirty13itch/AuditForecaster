# =============================================================================
# Field Inspect - Unraid Production Stack
# =============================================================================
# Deploy:
#   1. Copy this file + .env to /mnt/user/appdata/fieldinspect/
#   2. Build image locally: docker build -t fieldinspect:latest .
#   3. Run: docker compose -f docker-compose.prod.yml up -d
#
# Or use the deploy script from your Windows PC:
#   npm run deploy:preview
# =============================================================================

services:
  # ===========================================================================
  # APPLICATION
  # ===========================================================================
  app:
    container_name: fieldinspect-app
    image: fieldinspect:latest
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://fieldinspect:${POSTGRES_PASSWORD}@postgres:5432/fieldinspect
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://192.168.1.244:3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NODE_ENV=production
      # Email (optional)
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - EMAIL_FROM=${EMAIL_FROM:-}
      - ADMIN_NOTIFICATION_EMAIL=${ADMIN_NOTIFICATION_EMAIL:-}
      # Error tracking (optional)
      - NEXT_PUBLIC_SENTRY_DSN=${NEXT_PUBLIC_SENTRY_DSN:-}
      # Google OAuth (optional)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      # Webhooks (optional)
      - SUPPLYPRO_WEBHOOK_SECRET=${SUPPLYPRO_WEBHOOK_SECRET:-}
      - GOOGLE_CALENDAR_WEBHOOK_TOKEN=${GOOGLE_CALENDAR_WEBHOOK_TOKEN:-}
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - uploads:/app/public/uploads
    networks:
      - fieldinspect
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================================================
  # DATABASE
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: fieldinspect-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: fieldinspect
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: fieldinspect
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - fieldinspect
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fieldinspect"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # DATABASE BACKUPS (daily, keeps 30 days)
  # ===========================================================================
  db-backup:
    image: prodrigestivill/postgres-backup-local:16
    container_name: fieldinspect-backup
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=fieldinspect
      - POSTGRES_USER=fieldinspect
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - SCHEDULE=@daily
      - BACKUP_KEEP_DAYS=30
      - BACKUP_KEEP_WEEKS=4
      - BACKUP_KEEP_MONTHS=6
      - HEALTHCHECK_PORT=8080
    volumes:
      - backups:/backups
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - fieldinspect

# =============================================================================
# VOLUMES - Bind-mounted to Unraid appdata
# =============================================================================
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/mnt/user/appdata}/fieldinspect/postgres

  uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/mnt/user/appdata}/fieldinspect/uploads

  backups:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/mnt/user/appdata}/fieldinspect/backups

networks:
  fieldinspect:
    driver: bridge
